<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FoodShareTech - Relatório de Reivindicações ONG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body { padding-top: 56px; }
        nav .nav-link.active { font-weight: bold; }
        .status-pendente { color: orange; font-weight: 600; }
        .status-concluida { color: green; font-weight: 600; }
        .card-icon { font-size: 2.5rem; }
    </style>
</head>
<body>

<!-- Navbar topo -->
<nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top">
    <div class="container">
        <a class="navbar-brand" href="#">Sistema de Doações</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">   
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/home_ong.html">Home ONG</a></li>
                <li class="nav-item"><a class="nav-link" href="/confirmar_entrega_ong.html">Confirmar Coleta</a></li>
                <li class="nav-item"><a class="nav-link active" href="/relatorio_ong.html">Relatório</a></li>
                <li class="nav-item"><a class="nav-link" href="/perfil_ong.html">Perfil ONG</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h2 class="mb-4">Histórico e Análise de Reivindicações</h2>
    <div id="alertContainer"></div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Total de Reivindicações</h5>
                        <p class="card-text fs-3" id="totalReivindicacoes">0</p>
                    </div>
                    <i class="bi bi-list-ol card-icon"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Reivindicações Pendentes</h5>
                        <p class="card-text fs-3" id="reivindicacoesPendentes">0</p>
                    </div>
                    <i class="bi bi-hourglass-split card-icon"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Reivindicações Concluídas</h5>
                        <p class="card-text fs-3" id="reivindicacoesConcluidas">0</p>
                    </div>
                    <i class="bi bi-check-circle card-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Filtros de Reivindicações</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="filtroStatus" class="form-label">Status:</label>
                            <select class="form-select" id="filtroStatus">
                                <option value="">Todos os Resultados</option>
                                <option value="Coletado por sua ONG">Coletado por sua ONG</option>
                                <option value="Aguardando sua Coleta">Aguardando sua Coleta</option>
                                <option value="Em disputa">Em disputa</option>
                                <option value="Doação Cancelada">Doação Cancelada</option>
                                <option value="Disputa Encerrada (Não Venceu)">Disputa Encerrada (Não Venceu)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="filtroDataInicio" class="form-label">Data Início:</label>
                            <input type="date" class="form-control" id="filtroDataInicio">
                        </div>
                        <div class="col-md-4">
                            <label for="filtroDataFim" class="form-label">Data Fim:</label>
                            <input type="date" class="form-control" id="filtroDataFim">
                        </div>
                        <div class="col-12 text-end">
                            <button class="btn btn-primary" id="aplicarFiltros">Aplicar Filtros</button>
                            <button class="btn btn-secondary" id="limparFiltros">Limpar Filtros</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Reivindicações por Status</h5>
                    <canvas id="chartStatus"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Reivindicações por Prioridade</h5>
                    <canvas id="chartPrioridade"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">Detalhes das Reivindicações</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID Lance</th>
                            <th>Data do Lance</th>
                            <th>Sua Prioridade</th>
                            <th>Alimento</th>
                            <th>Doador</th>
                            <th>Resultado da Disputa</th>
                        </tr>
                    </thead>
                    <tbody id="reivindicacoesBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
     // Registra o plugin de datalabels para os gráficos
     Chart.register(ChartDataLabels);

    // Variáveis globais para os dados e gráficos
    let allReivindicacoes = [];
    let chartStatus;
    let chartPrioridade;

    // --- LÓGICA DE AUTENTICAÇÃO E EXECUÇÃO PRINCIPAL ---
    document.addEventListener('DOMContentLoaded', () => {
        const usuarioLogadoString = localStorage.getItem('usuarioLogado');
        const usuarioLogado = usuarioLogadoString ? JSON.parse(usuarioLogadoString) : null;

        if (!usuarioLogado || usuarioLogado.tipo !== 'ONG') {
            alert('Acesso não autorizado. Você precisa estar logado como uma ONG.');
            window.location.href = 'login.html';
            return; 
        }

        // Pega o ID de perfil da ONG logada e inicia o carregamento dos dados
        const idOngLogada = usuarioLogado.perfilId;
        carregarReivindicacoes(idOngLogada);

        // Adiciona os event listeners para os botões de filtro
        document.getElementById('aplicarFiltros').addEventListener('click', aplicarFiltros);
        document.getElementById('limparFiltros').addEventListener('click', limparFiltros);
    });

    /**
     * Atualiza os cartões de resumo com os dados totais, pendentes e concluídos.
     * @param {Array} reivindicacoes - Lista de reivindicações.
     */
     function atualizarCardsResumo(reivindicacoes) {
        document.getElementById('totalReivindicacoes').textContent = reivindicacoes.length;
        const pendentes = reivindicacoes.filter(item => item.resultadoFinal.toLowerCase() === 'em disputa').length;
        const concluidas = reivindicacoes.filter(item => item.resultadoFinal.toLowerCase().includes('coletado')).length;
        document.getElementById('reivindicacoesPendentes').textContent = pendentes;
        document.getElementById('reivindicacoesConcluidas').textContent = concluidas;
    }

    /**
     * Renderiza o gráfico de status das reivindicações.
     * @param {Array} reivindicacoes - Lista de reivindicações.
     */
     function renderChartStatus(reivindicacoes) {
        const statusCounts = {};
        // A lógica de contagem agora usa a coluna 'resultadoFinal'
        reivindicacoes.forEach(item => {
            const status = item.resultadoFinal;
            statusCounts[status] = (statusCounts[status] || 0) + 1;
        });

        const labels = Object.keys(statusCounts);
        const data = Object.values(statusCounts);
        
        // As cores podem ser ajustadas para os novos status se desejar
        const backgroundColors = labels.map(label => {
            if (label.toLowerCase().includes('coletado')) return 'rgba(75, 192, 192, 0.7)'; // Verde
            if (label.toLowerCase().includes('aguardando')) return 'rgba(255, 159, 64, 0.7)'; // Laranja
            if (label.toLowerCase().includes('em disputa')) return 'rgba(54, 162, 235, 0.7)'; // Azul
            return 'rgba(201, 203, 207, 0.7)'; // Cinza para outros
        });
        const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));

        const ctx = document.getElementById('chartStatus').getContext('2d');

        if (chartStatus) {
            chartStatus.destroy();
        }

        chartStatus = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            // O restante das suas opções de gráfico continua o mesmo...
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw;
                                const total = context.dataset.data.reduce((acc, current) => acc + current, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                return `${label}: ${value} (${percentage})`;
                            }
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        formatter: (value, context) => {
                            const total = context.dataset.data.reduce((acc, current) => acc + current, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '';
                            return value > 0 ? percentage : '';
                        }
                    }
                }
            }
        });
    }

    /**
     * Renderiza o gráfico de prioridade das reivindicações.
     * @param {Array} reivindicacoes - Lista de reivindicações.
     */
    function renderChartPrioridade(reivindicacoes) {
        // Agrupa por faixa de prioridade (ex: 0-25, 26-50, 51-75, 76-100)
        const prioridadeFaixas = {
            '0-25': 0,
            '26-50': 0,
            '51-75': 0,
            '76-100': 0
        };

        reivindicacoes.forEach(item => {
            const prioridade = item.prioridadeCalculada;
            if (prioridade >= 0 && prioridade <= 25) {
                prioridadeFaixas['0-25']++;
            } else if (prioridade > 25 && prioridade <= 50) {
                prioridadeFaixas['26-50']++;
            } else if (prioridade > 50 && prioridade <= 75) {
                prioridadeFaixas['51-75']++;
            } else if (prioridade > 75 && prioridade <= 100) {
                prioridadeFaixas['76-100']++;
            }
        });

        const labels = Object.keys(prioridadeFaixas);
        const data = Object.values(prioridadeFaixas);

        const ctx = document.getElementById('chartPrioridade').getContext('2d');

        if (chartPrioridade) {
            chartPrioridade.destroy(); // Destrói o gráfico anterior
        }

        chartPrioridade = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Número de Reivindicações',
                    data: data,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)', // Azul
                        'rgba(255, 206, 86, 0.7)', // Amarelo
                        'rgba(153, 102, 255, 0.7)', // Roxo
                        'rgba(255, 99, 132, 0.7)' // Vermelho
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantidade de Reivindicações'
                        },
                        ticks: {
                            precision: 0 // Garante que os ticks sejam números inteiros
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Faixa de Prioridade Calculada'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Reivindicações: ${context.raw}`;
                            }
                        }
                    },
                    datalabels: {
                        color: '#000',
                        anchor: 'end',
                        align: 'top',
                        formatter: (value) => value > 0 ? value : '' // Mostra o valor apenas se for maior que 0
                    }
                }
            }
        });
    }

    /**
     * Popula a tabela com as reivindicações filtradas.
     * @param {Array} reivindicacoesFiltradas - Lista de reivindicações a serem exibidas.
     */
     function popularTabela(reivindicacoesFiltradas) {
        const tbody = document.getElementById('reivindicacoesBody');
        tbody.innerHTML = ''; // Limpa a tabela

        if (reivindicacoesFiltradas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhuma reivindicação encontrada.</td></tr>';
            return;
        }

        reivindicacoesFiltradas.forEach(item => {
            const tr = document.createElement('tr');
            // A tabela agora é mais limpa e usa as novas colunas
            tr.innerHTML = `
                <td>${item.idReivindicacao}</td>
                <td>${new Date(item.dataReivindicacao).toLocaleString()}</td>
                <td>${item.prioridadeCalculada.toFixed(2)}</td>
                <td>${item.nomeAlimento}</td>
                <td>${item.nomeDoador}</td>
                <td><strong>${item.resultadoFinal}</strong></td>
            `;
            tbody.appendChild(tr);
        });
    }

    /**
     * Carrega as reivindicações da API e as exibe.
     * Aplica filtros e atualiza os gráficos e a tabela.
     */
     async function carregarReivindicacoes(idOng) { // A função agora recebe o id da ONG
        try {
            const resposta = await fetch(`/api/relatorios?tipo=ONG&id=${idOng}`);
            const dados = await resposta.json();

            if (!dados.success) {
                document.getElementById('alertContainer').innerHTML = `<div class="alert alert-danger">${dados.message || 'Erro ao carregar relatório.'}</div>`;
                return;
            }
            
            allReivindicacoes = dados.relatorio; 

            aplicarFiltros(); 
            atualizarCardsResumo(allReivindicacoes);
            renderChartStatus(allReivindicacoes);
            renderChartPrioridade(allReivindicacoes);

        } catch (error) {
            document.getElementById('alertContainer').innerHTML = `<div class="alert alert-danger">Erro de comunicação ao carregar relatório.</div>`;
            console.error(error);
        }
    }

    /**
     * Aplica os filtros selecionados e atualiza a tabela.
     */
     function aplicarFiltros() {
        let reivindicacoesFiltradas = [...allReivindicacoes];

        const filtroStatus = document.getElementById('filtroStatus').value;
        const filtroDataInicio = document.getElementById('filtroDataInicio').value;
        const filtroDataFim = document.getElementById('filtroDataFim').value;

        if (filtroStatus) {
            // A lógica de filtro agora usa a coluna 'resultadoFinal'
            reivindicacoesFiltradas = reivindicacoesFiltradas.filter(item => 
                item.resultadoFinal === filtroStatus
            );
        }

        if (filtroDataInicio) {
            // ... a lógica de filtro de data continua a mesma
            const dataInicio = new Date(filtroDataInicio + 'T00:00:00');
            reivindicacoesFiltradas = reivindicacoesFiltradas.filter(item => {
                const dataReivindicacao = new Date(item.dataReivindicacao);
                return dataReivindicacao >= dataInicio;
            });
        }

        if (filtroDataFim) {
            // ... a lógica de filtro de data continua a mesma
            const dataFim = new Date(filtroDataFim + 'T23:59:59');
            reivindicacoesFiltradas = reivindicacoesFiltradas.filter(item => {
                const dataReivindicacao = new Date(item.dataReivindicacao);
                return dataReivindicacao <= dataFim;
            });
        }

        popularTabela(reivindicacoesFiltradas);
        // Atualiza os gráficos também com os dados filtrados
        renderChartStatus(reivindicacoesFiltradas);
        renderChartPrioridade(reivindicacoesFiltradas);
    }

    /**
     * Limpa todos os filtros e recarrega os dados originais.
     */
    function limparFiltros() {
        document.getElementById('filtroStatus').value = '';
        document.getElementById('filtroDataInicio').value = '';
        document.getElementById('filtroDataFim').value = '';
        aplicarFiltros(); // Re-aplica os filtros (agora vazios) para mostrar todos os dados
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', carregarReivindicacoes);
    document.getElementById('aplicarFiltros').addEventListener('click', aplicarFiltros);
    document.getElementById('limparFiltros').addEventListener('click', limparFiltros);
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</body>
</html>