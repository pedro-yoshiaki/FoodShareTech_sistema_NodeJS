<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodShareTech - Perfil</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f8f9fa;
      padding-top: 70px;
      color: #343a40;
    }
    .navbar { box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .navbar-brand { font-weight: 700; font-size: 1.5rem; }
    .nav-link { font-weight: 500; transition: color .3s; }
    .nav-link:hover, .nav-link.active { color: #ffc107 !important; }

    .offcanvas { width: 250px; }

    .form-section { background: #fff; border-radius: .75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 1.5rem; }
    h2, h4 { font-weight: 600; color: #007bff; }
    .btn-primary { background: #007bff; border: none; border-radius: .5rem; padding: .5rem 1.5rem; font-weight: 600; transition: background .3s; }
    .btn-primary:hover { background: #0056b3; }
    .btn-secondary { border-radius: .5rem; }
    .btn-danger { border-radius: .5rem; }
  </style>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top">
  <div class="container">
    <a class="navbar-brand text-primary" href="#">FoodShareTech</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Alternar navegação">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="/view/new_pages/home_doador.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/view/new_pages/confirmar_coleta_doador.html">Confirmar Coleta</a></li>
        <li class="nav-item"><a class="nav-link active" href="/view/new_pages/perfil_doador">Perfil</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="form-section">
    <h2>Meu Perfil</h2>
    <form id="formPerfil">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="form-floating">
            <input type="text" id="nome" class="form-control" placeholder="Nome" required />
            <label for="nome">Nome</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-floating">
            <input type="email" id="email" class="form-control" placeholder="Email" required />
            <label for="email">Email</label>
          </div>
        </div>
      </div>

      <hr />
      <h4>Endereço</h4>
      <div class="row g-3">
        <div class="col-md-4">
          <div class="form-floating">
            <input type="text" id="estado" class="form-control" placeholder="Estado" required />
            <label for="estado">Estado</label>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-floating">
            <input type="text" id="cidade" class="form-control" placeholder="Cidade" required />
            <label for="cidade">Cidade</label>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-floating">
            <input type="text" id="bairro" class="form-control" placeholder="Bairro" required />
            <label for="bairro">Bairro</label>
          </div>
        </div>
        <div class="col-md-8">
          <div class="form-floating">
            <input type="text" id="logradouro" class="form-control" placeholder="Logradouro" required />
            <label for="logradouro">Logradouro</label>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-floating">
            <input type="text" id="numero" class="form-control" placeholder="Número" required />
            <label for="numero">Número</label>
          </div>
        </div>
      </div>

      <hr />
      <h4>Contatos</h4>
      <div id="contatosContainer" class="mb-3"></div>
      <button type="button" class="btn btn-secondary mb-4" id="btnAddContato">Adicionar Contato</button>

      <div class="d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        <button type="button" class="btn btn-danger" id="btnExcluirConta">Excluir Conta</button>
      </div>
    </form>
  </div>
</div>

<script>
  const idUsuario = 1;
  async function carregarPerfil() {
    const res = await fetch(`/api/usuarios/me?idOng=${idUsuario}`);
    const data = await res.json();
    if (data.success) {
      document.getElementById('nome').value = data.usuario.nome;
      document.getElementById('email').value = data.usuario.email;
      document.getElementById('estado').value = data.endereco.estado;
      document.getElementById('cidade').value = data.endereco.cidade;
      document.getElementById('bairro').value = data.endereco.bairro;
      document.getElementById('logradouro').value = data.endereco.logradouro;
      document.getElementById('numero').value = data.endereco.numero;
      const cont = document.getElementById('contatosContainer'); cont.innerHTML = '';
      data.contatos.forEach(c => {
        const inp = document.createElement('input');
        inp.type = 'text'; inp.className = 'form-control mb-2'; inp.name = 'contatos'; inp.value = c.telefone;
        cont.appendChild(inp);
      });
    }
  }
  document.getElementById('btnAddContato').onclick = () => {
    const inp = document.createElement('input'); inp.type = 'text'; inp.className = 'form-control mb-2'; inp.name = 'contatos';
    document.getElementById('contatosContainer').appendChild(inp);
  };
  document.getElementById('formPerfil').onsubmit = async e => {
    e.preventDefault();
    const contatos = Array.from(document.getElementsByName('contatos')).map(i => i.value);
    const payload = {
      nome: document.getElementById('nome').value,
      email: document.getElementById('email').value,
      endereco: {
        estado: document.getElementById('estado').value,
        cidade: document.getElementById('cidade').value,
        bairro: document.getElementById('bairro').value,
        logradouro: document.getElementById('logradouro').value,
        numero: document.getElementById('numero').value
      },
      contatos
    };
    const res = await fetch('/api/usuarios/me', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const ret = await res.json(); alert(ret.message);
  };
  document.getElementById('btnExcluirConta').onclick = async () => {
    if (confirm('Tem certeza que deseja excluir sua conta?')) {
      const res = await fetch('/api/usuarios/me', { method: 'DELETE' });
      const ret = await res.json();
      if (ret.success) window.location.href = '/login'; else alert('Erro ao excluir conta.');
    }
  };
  carregarPerfil();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
